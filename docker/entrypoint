#!/bin/bash

set -e # 命令出错就退出
trap 'catchError $LINENO $BASH_COMMAND' SIGHUP SIGINT SIGQUIT EXIT # 捕获错误情况

catchError() {
    exit_code=$?
    if [ $exit_code -ne 0 ]; then
        fail "\033[31mcommand: $2\n  at $0:$1\n  at $STEP\033[0m"
    fi
    exit $exit_code
}

success() {
    echo -e "\033[42;37m 成功 \033[0m $1"
}

fail() {
    echo -e "\033[41;37m 失败 \033[0m $1"
}

echo "start"
python --version
node --version

ACTION_MODE=$( export ACTION_MODE )
if [ $ACTION_MODE!='true' ]; then
    npm set registry https://r.npm.taobao.org # 注册模块镜像
    npm set disturl https://npm.taobao.org/dist # node-gyp 编译依赖的 node 源码镜像
    npm cache clean --force # 清空缓存
    echo "\
    deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free\
    # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free
    deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free\
    # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free
    deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free\
    # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free
    deb https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free\
    # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free
    "> /etc/apt/sources.list
fi

apt-get clean;  # 清空缓存
apt-get update;  # 更新
apt-get install -y libx11-dev libxkbfile-dev p7zip-full

npm install -g npm
npm install -g node-gyp
node-gyp install
node-gyp list


# test
# cd /
# mkdir -p test
# rm -rf test.a
# exec /workspace/tools/rebuild-node-modules

# exit 0;
# end test

cd /workspace
# export https_proxy="http://192.168.249.236:7890"
exec ./tools/setup-wechat-devtools-bash
